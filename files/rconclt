#! /usr/bin/env python3
"""rconclt.

A Minecraft RCON client.

Usage:
    rconclt <server> <command> [<args>...] [options]

Options:
    --help, -h          Shows this paage.
    --passwd=<passwd>   Specifies the respective RCON password.
"""
from docopt import docopt
from sys import exit as exit_, stderr

from mcipc.config import servers
from mcipc.rcon.client import Client


def _get_socket_by_server_name(server):
    """Returns the respective socket by server name."""

    try:
        return servers()[server]
    except KeyError:
        print('No such server:', server, file=stderr, flush=True)
        exit_(3)


def main(options):
    """Test the packet stuff."""

    server = options['<server>']

    try:
        host, port = server.split(':')
    except ValueError:
        host, port, passwd = _get_socket_by_server_name(server)
    else:
        port = int(port)
        passwd = None

    if passwd is None:
        passwd = options['--passwd'] or ''

    with Client(host, port) as client:
        if client.login(passwd):
            result = client.run(options['<command>'], *options['<args>'])
            print(result, flush=True)
        else:
            print('Failed to log in.', file=stderr, flush=True)
            exit_(1)


if __name__ == '__main__':
    main(docopt(__doc__))
